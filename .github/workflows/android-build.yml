name: Build Chatbox Android APK (Ultimate Debug Edition v3 - Fixed)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"

jobs:
  build-android-arm64-debug:
    name: Build Android for Debug (arm64-v8a)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Create capacitor.config.ts
        run: |
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          
          const config: CapacitorConfig = {
            appId: 'xyz.chatboxapp.ce',
            appName: 'Chatbox',
            webDir: 'release/app/dist/renderer',
            plugins: {
              CapacitorHttp: { enabled: true },
            },
          };
          
          export default config;
          EOF
          echo "✅ Created capacitor.config.ts"

      - name: Install dependencies and Sharp
        run: |
          npm install --ignore-scripts
          npx patch-package || echo "::warning::Patch application may have warnings (non-critical)"
          if npm install sharp; then
            echo "Rebuilding Sharp native bindings..."
            npm rebuild sharp || echo "::warning::Sharp rebuild failed, will use default icons."
          else
            echo "::warning::Sharp installation failed, will use default icons."
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Create debug-bridge.js for WebView injection
        run: |
          mkdir -p android/app/src/main/assets
          cat > android/app/src/main/assets/debug-bridge.js << 'JS_EOF'
          // Injected Debug Bridge v1.1
          (function() {
              if (window.__DEBUG_BRIDGE_INITIALIZED__) return;
              window.__DEBUG_BRIDGE_INITIALIZED__ = true;
          
              const originalConsole = { ...window.console };
              const logToNative = (level, args) => {
                  try {
                      const message = args.map(arg => {
                          if (arg instanceof Error) return arg.stack || arg.message;
                          try {
                            if (typeof arg === 'object' && arg !== null) return JSON.stringify(arg);
                          } catch (e) { return '[Unserializable Object]'; }
                          return String(arg);
                      }).join(' ');
                      
                      if (window.AndroidBridge && typeof window.AndroidBridge.log === 'function') {
                          window.AndroidBridge.log(`JS_CONSOLE_${level.toUpperCase()}: ${message}`);
                      }
                  } catch (e) {
                      originalConsole.error('Debug bridge failed:', e);
                  }
              };
          
              Object.keys(originalConsole).forEach(level => {
                  if (typeof originalConsole[level] === 'function') {
                      window.console[level] = (...args) => {
                          originalConsole[level](...args);
                          logToNative(level, args);
                      };
                  }
              });
          
              const originalFetch = window.fetch;
              window.fetch = function(...args) {
                  const url = args[0] instanceof Request ? args[0].url : String(args[0]);
                  const method = (args[0] instanceof Request ? args[0].method : (args[1]?.method || 'GET')).toUpperCase();
                  logToNative('fetch', [`--> ${method} ${url}`]);
                  
                  return originalFetch.apply(this, args).then(response => {
                      logToNative('fetch', [`<-- ${response.status} ${response.url}`]);
                      return response;
                  }).catch(error => {
                      logToNative('error', [`FETCH_ERROR: ${error.message}`]);
                      throw error;
                  });
              };
          
              console.log('✅ Injected Debug Bridge is active.');
          })();
          JS_EOF
          echo "✅ Created debug-bridge.js in android assets"

      - name: Inject Ultimate Debug MainActivity.java (FIXED)
        run: |
          MAIN_JAVA="android/app/src/main/java/xyz/chatboxapp/ce/MainActivity.java"
          mkdir -p "$(dirname "$MAIN_JAVA")"
          
          cat > "$MAIN_JAVA" << 'JAVA_EOF'
          package xyz.chatboxapp.ce;

          import android.Manifest;
          import android.content.pm.PackageManager;
          import android.os.Build;
          import android.os.Bundle;
          import android.os.Environment;
          import android.webkit.JavascriptInterface;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import androidx.core.app.ActivityCompat;
          import androidx.core.content.ContextCompat;
          import com.getcapacitor.BridgeActivity;
          import java.io.File;
          import java.io.FileWriter;
          import java.io.IOException;
          import java.io.InputStream;
          import java.io.PrintWriter;
          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.Locale;

          public class MainActivity extends BridgeActivity {
              private static final int REQUEST_STORAGE_PERMISSIONS = 1001;
              private boolean hasStoragePermission = false;

              private File publicLogFile;
              private File privateExternalLogFile;
              private File privateInternalLogFile;

              private synchronized void writeToLogs(String message) {
                  String timestamp = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS", Locale.getDefault()).format(new Date());
                  String logLine = timestamp + " " + message;
                  
                  android.util.Log.d("ChatboxUltimateDebug", message);
                  
                  if (!hasStoragePermission) return;

                  writeLogToFile(publicLogFile, logLine);
                  writeLogToFile(privateExternalLogFile, logLine);
                  writeLogToFile(privateInternalLogFile, logLine);
              }

              private void writeLogToFile(File file, String logLine) {
                  if (file == null) return;
                  try (FileWriter fw = new FileWriter(file, true);
                       PrintWriter pw = new PrintWriter(fw)) {
                      pw.println(logLine);
                  } catch (IOException e) {
                      android.util.Log.e("ChatboxUltimateDebug", "Failed to write to " + file.getAbsolutePath(), e);
                  }
              }

              private void checkAndRequestPermissions() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
                      hasStoragePermission = true;
                      return;
                  }
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
                      ActivityCompat.requestPermissions(this, new String[]{
                          Manifest.permission.READ_EXTERNAL_STORAGE,
                          Manifest.permission.WRITE_EXTERNAL_STORAGE
                      }, REQUEST_STORAGE_PERMISSIONS);
                  } else {
                      hasStoragePermission = true;
                  }
              }

              @Override
              public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
                  super.onRequestPermissionsResult(requestCode, permissions, grantResults);
                  if (requestCode == REQUEST_STORAGE_PERMISSIONS) {
                      if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                          hasStoragePermission = true;
                          writeToLogs("INFO: Storage permission granted by user.");
                          initializeLogFiles();
                      } else {
                          writeToLogs("ERROR: Storage permission DENIED by user.");
                      }
                  }
              }

              private void initializeLogFiles() {
                  if (hasStoragePermission) {
                      if (Build.VERSION.SDK_INT < Build.VERSION_CODES.R) {
                        publicLogFile = new File(Environment.getExternalStorageDirectory(), "chatbox_public_debug.log");
                      }
                      File externalDir = getExternalFilesDir(null);
                      if (externalDir != null) {
                          privateExternalLogFile = new File(externalDir, "chatbox_private_external.log");
                      }
                      privateInternalLogFile = new File(getFilesDir(), "chatbox_private_internal.log");
                      
                      writeToLogs("INFO: Log files initialized.");
                      if (publicLogFile != null) writeToLogs(" - Public Log: " + publicLogFile.getAbsolutePath());
                      if (privateExternalLogFile != null) writeToLogs(" - Private External Log: " + privateExternalLogFile.getAbsolutePath());
                      if (privateInternalLogFile != null) writeToLogs(" - Private Internal Log: " + privateInternalLogFile.getAbsolutePath());
                  }
              }
              
              public class AndroidBridge {
                  @JavascriptInterface
                  public void log(String message) {
                      writeToLogs("JS_BRIDGE: " + message);
                  }
              }

              @Override
              public void onCreate(Bundle savedInstanceState) {
                  checkAndRequestPermissions();
                  initializeLogFiles();
                  
                  writeToLogs("=== MainActivity onCreate START (Ultimate Debug) ===");
                  
                  super.onCreate(savedInstanceState);
                  
                  WebView webView = getBridge().getWebView();
                  if (webView != null) {
                      WebView.setWebContentsDebuggingEnabled(true);
                      WebSettings settings = webView.getSettings();
                      settings.setJavaScriptEnabled(true);
                      webView.addJavascriptInterface(new AndroidBridge(), "AndroidBridge");
                      
                      try {
                          InputStream is = getAssets().open("debug-bridge.js");
                          byte[] buffer = new byte[is.available()];
                          is.read(buffer);
                          is.close();
                          String js = new String(buffer, "UTF-8");
                          webView.evaluateJavascript(js, null);
                          writeToLogs("INFO: Injected debug-bridge.js into WebView.");
                      } catch (Exception e) {
                          writeToLogs("ERROR: Failed to inject debug-bridge.js: " + e.getMessage());
                      }
                  } else {
                       writeToLogs("ERROR: Bridge or WebView is null during onCreate!");
                  }
                  writeToLogs("=== MainActivity onCreate COMPLETE ===");
              }

              // --- FIXED LIFECYCLE METHODS ---
              @Override
              public void onStart() {
                  super.onStart();
                  writeToLogs("=== onStart ===");
              }
              
              @Override
              public void onResume() {
                  super.onResume();
                  writeToLogs("=== onResume ===");
              }
              
              @Override
              public void onPause() {
                  super.onPause();
                  writeToLogs("=== onPause ===");
              }
              
              @Override
              public void onDestroy() {
                  super.onDestroy();
                  writeToLogs("=== onDestroy ===");
              }
          }
          JAVA_EOF
          echo "✅ MainActivity injected with FIXED Ultimate Debug capabilities."

      - name: Fix AndroidManifest.xml for full permissions and network
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          # Add all necessary permissions
          if ! grep -q 'android.permission.INTERNET' "$MANIFEST"; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.INTERNET" />' "$MANIFEST"
          fi
          if ! grep -q 'android.permission.READ_EXTERNAL_STORAGE' "$MANIFEST"; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />' "$MANIFEST"
          fi
          if ! grep -q 'android.permission.WRITE_EXTERNAL_STORAGE' "$MANIFEST"; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="29" />' "$MANIFEST"
          fi
          if ! grep -q 'android.permission.ACCESS_NETWORK_STATE' "$MANIFEST"; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' "$MANIFEST"
          fi
          if ! grep -q 'android.permission.READ_CLIPBOARD' "$MANIFEST"; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.READ_CLIPBOARD" />' "$MANIFEST"
          fi
          echo "✅ Added all necessary permissions to AndroidManifest.xml"

          # Add permissive network security config
          if ! grep -q 'android:networkSecurityConfig' "$MANIFEST"; then
            sed -i '/<application/a\        android:networkSecurityConfig="@xml/network_security_config"' "$MANIFEST"
          fi
          if ! grep -q 'android:usesCleartextTraffic' "$MANIFEST"; then
            sed -i '/<application/a\        android:usesCleartextTraffic="true"' "$MANIFEST"
          fi

          NSC_FILE="android/app/src/main/res/xml/network_security_config.xml"
          mkdir -p "$(dirname "$NSC_FILE")"
          echo '<?xml version="1.0" encoding="utf-8"?><network-security-config><base-config cleartextTrafficPermitted="true"><trust-anchors><certificates src="system" /></trust-anchors></base-config></network-security-config>' > "$NSC_FILE"
          echo "✅ Added permissive network security config"
      
      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build web assets
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          export CHATBOX_BUILD_PLATFORM=android
          export NODE_ENV=production
          export TS_NODE_TRANSPILE_ONLY=true
          npm run build:renderer

      - name: Sync Capacitor assets
        run: npx cap sync android

      - name: Build release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace --build-cache
          cd ..

      - name: Package APK
        id: package_apk
        run: |
          APK_PATH=$(find android/app/build/outputs/apk/release -name "app-release-unsigned.apk" -o -name "app-release.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::Release APK not found!"
            exit 1
          fi
          
          VERSION=$(node -p "require('./package.json').version")
          NAME="Chatbox-Debug-${VERSION}-arm64.apk"
          
          mkdir -p artifacts
          cp "$APK_PATH" "artifacts/$NAME"
          
          echo "apk_name=$NAME" >> $GITHUB_OUTPUT
          echo "✅ Packaged APK as $NAME"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-debug-apk
          path: artifacts/${{ steps.package_apk.outputs.apk_name }}
          if-no-files-found: error
