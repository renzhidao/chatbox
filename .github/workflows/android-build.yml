name: Build Chatbox Android APK (arm64-v8a)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"

jobs:
  build-android-arm64:
    name: Build Android (arm64-v8a)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Create capacitor.config.ts
        run: |
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'xyz.chatboxapp.ce',
            appName: 'Chatbox',
            webDir: 'release/app/dist/renderer',
            plugins: { CapacitorHttp: { enabled: true } },
          };
          export default config;
          EOF

      - name: Install dependencies (ignore scripts)
        run: npm install --ignore-scripts

      - name: Apply dependency patches
        run: npx patch-package

      - name: Install Sharp (for icon generation)
        run: |
          if npm install sharp --ignore-scripts=false; then
            echo "✅ Sharp installed successfully"
          else
            echo "::warning::Sharp installation failed, default icons will be used"
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Generate mobile assets (icons and splash screens)
        run: |
          if npm run mobile:assets; then
            echo "✅ Custom icons and splash screens generated"
            ls -la android/app/src/main/res/mipmap-* 2>/dev/null || true
          else
            echo "::warning::Custom assets generation failed, using default Capacitor icons"
          fi
      
      - name: Setup Java JDK 17 and Gradle Cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Cache Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            android/gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/daemon
          key: ${{ runner.os }}-gradle-deps-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-deps-

      - name: Cache Gradle Build Cache
        uses: actions/cache@v4
        with:
          path: |
            android/.gradle
            android/app/build
          key: ${{ runner.os }}-gradle-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-gradle-build-

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_HOME }}/platforms
            ${{ env.ANDROID_HOME }}/build-tools
            ${{ env.ANDROID_HOME }}/platform-tools
            ${{ env.ANDROID_HOME }}/cmdline-tools
          key: ${{ runner.os }}-android-sdk-${{ hashFiles('android/app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Accept Android SDK Licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Build web assets for Mobile
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          export CHATBOX_BUILD_PLATFORM=android
          export NODE_ENV=production
          export TS_NODE_TRANSPILE_ONLY=true
          npm run build:renderer

      - name: Verify build output exists
        run: |
          WEB_DIR="release/app/dist/renderer"
          
          if [ ! -d "$WEB_DIR" ]; then
            echo "::error::Web directory $WEB_DIR not found!"
            exit 1
          fi
          
          if [ ! -f "$WEB_DIR/index.html" ]; then
            echo "::error::index.html not found in $WEB_DIR!"
            exit 1
          fi
          
          echo "✅ Build output verified: $WEB_DIR"
          echo "Build size: $(du -sh "$WEB_DIR" | cut -f1)"

      - name: Delete source maps
        run: find ./release/app/dist/renderer -type f -name "*.map" -delete 2>/dev/null || true

      - name: Sync Capacitor assets
        run: npx cap sync android

      - name: Verify Capacitor sync completed
        run: |
          ASSETS_BASE="android/app/src/main/assets"
          
          if [ -d "$ASSETS_BASE/public" ]; then
            ANDROID_ASSETS="$ASSETS_BASE/public"
          elif [ -d "$ASSETS_BASE/www" ]; then
            ANDROID_ASSETS="$ASSETS_BASE/www"
          else
            echo "::error::Android assets directory not found!"
            echo "Searched in: $ASSETS_BASE/public and $ASSETS_BASE/www"
            echo "Available directories:"
            ls -la "$ASSETS_BASE/" || true
            exit 1
          fi
          
          if [ ! -f "$ANDROID_ASSETS/index.html" ]; then
            echo "::error::index.html not found in Android assets!"
            echo "Contents of $ANDROID_ASSETS:"
            ls -la "$ANDROID_ASSETS/" || true
            exit 1
          fi
          
          echo "✅ Capacitor sync verified"
          echo "Assets location: $ANDROID_ASSETS"
          echo "Assets size: $(du -sh "$ANDROID_ASSETS" | cut -f1)"

      - name: Debug - Check synced assets
        run: |
          echo "=== Capacitor config ==="
          cat capacitor.config.ts
          echo ""
          echo "=== Android assets directory content ==="
          ls -lh android/app/src/main/assets/public/ | head -30
          echo ""
          echo "=== Check for index.html ==="
          if [ -f "android/app/src/main/assets/public/index.html" ]; then
            echo "✅ index.html exists"
            echo "Size: $(ls -lh android/app/src/main/assets/public/index.html | awk '{print $5}')"
          else
            echo "❌ index.html NOT found!"
          fi
          echo ""
          echo "=== Check assets subdirectories ==="
          du -sh android/app/src/main/assets/public/* 2>/dev/null || true
          echo ""
          echo "=== Original build output size breakdown ==="
          du -sh release/app/dist/renderer/* 2>/dev/null | sort -rh | head -20
          echo ""
          echo "=== CRITICAL: Check for JavaScript files ==="
          find android/app/src/main/assets/public/assets -name "*.js" | head -20
          echo ""
          echo "=== Directory structure of assets ==="
          ls -R android/app/src/main/assets/public/assets/ | head -50

      - name: Prepare release keystore
        run: |
          set -e
          if [ -n "${{ secrets.SIGN_KEYSTORE_BASE64 }}" ]; then
            echo "Using secrets for release signing."
            echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
            cat > android/key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
          else
            echo "Generating temporary keystore."
            keytool -genkey -v -keystore android/app/upload-keystore.jks \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass android -keypass android \
              -alias androiddebugkey \
              -dname "CN=Android Debug, O=Android, C=US"
            cat > android/key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=android
          keyAlias=androiddebugkey
          keyPassword=android
          EOF
          fi

      - name: Configure build.gradle for arm64 and signing
        run: |
          BUILD_GRADLE="android/app/build.gradle"
          
          cat > "${BUILD_GRADLE}.tmp" << 'HEADER_EOF'
          def keystorePropertiesFile = rootProject.file('key.properties')
          def keystoreProperties = new Properties()
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
          }
          
          HEADER_EOF
          cat "$BUILD_GRADLE" >> "${BUILD_GRADLE}.tmp"
          mv "${BUILD_GRADLE}.tmp" "$BUILD_GRADLE"
          
          sed -i '/^android {/a\
              splits {\
                  abi {\
                      enable false\
                  }\
                  density {\
                      enable false\
                  }\
              }' "$BUILD_GRADLE"
          
          sed -i '/defaultConfig {/a\
              ndk {\
                  abiFilters "arm64-v8a"\
              }' "$BUILD_GRADLE"
          
          sed -i '/^android {/a\
              if (keystorePropertiesFile.exists()) {\
                  signingConfigs {\
                      release {\
                          storeFile file(keystoreProperties["storeFile"])\
                          storePassword keystoreProperties["storePassword"]\
                          keyAlias keystoreProperties["keyAlias"]\
                          keyPassword keystoreProperties["keyPassword"]\
                      }\
                  }\
              }' "$BUILD_GRADLE"
          
          sed -i '/buildTypes {/,/release {/{
              /release {/a\
                  if (keystorePropertiesFile.exists()) {\
                      signingConfig signingConfigs.release\
                  }
          }' "$BUILD_GRADLE"

      - name: Build arm64-v8a APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace --build-cache
          cd ..
      
      - name: Find and package APK
        id: find_apk
        run: |
          set -e
          
          STANDARD_APK="android/app/build/outputs/apk/release/app-release.apk"
          
          if [ -f "$STANDARD_APK" ]; then
            APK_PATH="$STANDARD_APK"
          else
            APK_PATH=$(find android/app/build/outputs/apk/release -type f \
              \( -name "app-release.apk" -o -name "*-release.apk" \) \
              ! -name "*unsigned*" | head -n 1)
            
            if [ -z "$APK_PATH" ]; then
              echo "::error::APK not found!"
              find android/app/build/outputs -type f
              exit 1
            fi
          fi
          
          echo "✅ Found APK: $APK_PATH"
          ls -lh "$APK_PATH"
          
          VERSION=$(node -p "require('./package.json').version")
          mkdir -p artifacts
          PRODUCT_NAME=$(node -p "require('./package.json').productName || 'chatbox'")
          NEW_NAME="${PRODUCT_NAME}-android-${VERSION}-arm64-v8a.apk"
          cp "$APK_PATH" "artifacts/$NEW_NAME"
          echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "✅ APK packaged as: $NEW_NAME"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-arm64-v8a
          path: artifacts/${{ steps.find_apk.outputs.apk_name }}
          if-no-files-found: error
