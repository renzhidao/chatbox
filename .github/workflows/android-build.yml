name: Build Chatbox Android APK (arm64-v8a)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"

jobs:
  build-android-arm64:
    name: Build Android (arm64-v8a)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Create capacitor.config.ts
        run: |
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'xyz.chatboxapp.ce',
            appName: 'Chatbox',
            webDir: 'release/app/dist/renderer',
            plugins: { CapacitorHttp: { enabled: true } },
          };
          export default config;
          EOF
          echo "‚úÖ Created capacitor.config.ts"

      - name: Install dependencies (without scripts)
        run: npm install --ignore-scripts

      - name: Apply patches
        run: npx patch-package || echo "::warning::Patch warnings (non-critical)"

      - name: Install and verify Sharp
        run: |
          echo "Installing Sharp..."
          if npm install sharp; then
            echo "Rebuilding Sharp native bindings..."
            npm rebuild sharp || echo "::warning::Sharp rebuild failed"
            
            echo "Verifying Sharp..."
            if node -e "require('sharp')" 2>/dev/null; then
              echo "‚úÖ Sharp is ready"
            else
              echo "::warning::Sharp verification failed - will use default icons"
            fi
          else
            echo "::warning::Sharp install failed - will use default icons"
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Generate Android assets
        run: npx capacitor-assets generate --android || echo "::warning::Asset generation failed, using defaults"
      
      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Cache Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            android/gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/daemon
          key: ${{ runner.os }}-gradle-deps-${{ hashFiles('android/**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-deps-

      - name: Cache Gradle Build
        uses: actions/cache@v4
        with:
          path: |
            android/.gradle
            android/app/build
          key: ${{ runner.os }}-gradle-build-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-build-

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_HOME }}/platforms
            ${{ env.ANDROID_HOME }}/build-tools
          key: ${{ runner.os }}-android-sdk
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Cache auto-generated keystore
        uses: actions/cache@v4
        with:
          path: .github/cache/upload-keystore.jks
          key: ${{ runner.os }}-auto-keystore
          restore-keys: |
            ${{ runner.os }}-auto-keystore

      - name: Accept SDK Licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Build web assets
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          export CHATBOX_BUILD_PLATFORM=android
          export NODE_ENV=production
          export TS_NODE_TRANSPILE_ONLY=true
          npm run build:renderer

      - name: Verify build output
        run: |
          [ -d "release/app/dist/renderer" ] || { echo "::error::Build directory missing"; exit 1; }
          [ -f "release/app/dist/renderer/index.html" ] || { echo "::error::index.html missing"; exit 1; }
          echo "‚úÖ Build verified ($(du -sh release/app/dist/renderer | cut -f1))"

      - name: Delete source maps
        run: find ./release/app/dist/renderer -name "*.map" -delete 2>/dev/null || true

      - name: Sync Capacitor assets
        run: npx cap sync android

      - name: Verify Capacitor sync
        run: |
          ASSETS="android/app/src/main/assets"
          if [ -d "$ASSETS/public" ]; then
            DIR="$ASSETS/public"
          elif [ -d "$ASSETS/www" ]; then
            DIR="$ASSETS/www"
          else
            echo "::error::Assets directory not found"
            exit 1
          fi
          
          [ -f "$DIR/index.html" ] || { echo "::error::index.html not synced"; exit 1; }
          echo "‚úÖ Sync verified ($(du -sh "$DIR" | cut -f1))"

      - name: Complete Android diagnostics
        shell: bash
        run: |
          set +e
          echo "======================================"
          echo "=== COMPLETE ANDROID DIAGNOSTICS ==="
          echo "======================================"
          
          echo ""
          echo "=== 1. Capacitor Configs ==="
          echo "--- TypeScript Config ---"
          cat capacitor.config.ts || true
          echo ""
          echo "--- Runtime JSON Config ---"
          cat android/app/src/main/assets/capacitor.config.json 2>/dev/null || echo "‚ùå Not found"
          
          echo ""
          echo "=== 2. Complete Android Structure ==="
          if command -v tree >/dev/null 2>&1; then
            tree -L 4 android/app/src/ 2>/dev/null || true
          else
            echo "Directory structure:"
            find android/app/src -type d 2>/dev/null | sort || true
          fi
          
          echo ""
          echo "=== 3. MainActivity Search ==="
          echo "Searching for MainActivity files:"
          find android -type f \( -name "MainActivity.java" -o -name "MainActivity.kt" \) 2>/dev/null || echo "‚ùå No MainActivity found"
          
          MAIN_JAVA=$(find android/app/src/main -name "MainActivity.java" 2>/dev/null || true)
          MAIN_KT=$(find android/app/src/main -name "MainActivity.kt" 2>/dev/null || true)
          
          if [ -n "$MAIN_JAVA" ]; then
            echo "‚úÖ Found Java: $MAIN_JAVA"
          elif [ -n "$MAIN_KT" ]; then
            echo "‚úÖ Found Kotlin: $MAIN_KT"
          else
            echo "‚ùå MainActivity not found in standard location"
          fi
          
          echo ""
          echo "=== 4. COMPLETE MainActivity Content ==="
          MAIN_FILE="${MAIN_JAVA:-$MAIN_KT}"
          if [ -n "$MAIN_FILE" ] && [ -f "$MAIN_FILE" ]; then
            echo "--- Full content of $MAIN_FILE ---"
            cat "$MAIN_FILE" 2>/dev/null || echo "Cannot read file"
          else
            echo "‚ùå MainActivity file not accessible"
          fi
          
          echo ""
          echo "=== 5. COMPLETE AndroidManifest.xml ==="
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            echo "--- Full AndroidManifest.xml ---"
            cat android/app/src/main/AndroidManifest.xml
          else
            echo "‚ùå AndroidManifest.xml not found"
          fi
          
          echo ""
          echo "=== 6. Complete Assets Directory Listing ==="
          echo "Full directory tree:"
          if command -v tree >/dev/null 2>&1; then
            tree android/app/src/main/assets/public/ 2>/dev/null || true
          else
            find android/app/src/main/assets/public -type f 2>/dev/null | sort || echo "‚ùå Assets not found"
          fi
          
          echo ""
          echo "Detailed file listing:"
          ls -lhR android/app/src/main/assets/public/ 2>/dev/null || echo "‚ùå Cannot list"
          
          echo ""
          echo "=== 7. JavaScript Files Analysis ==="
          JS_COUNT=$(find android/app/src/main/assets/public -name "*.js" 2>/dev/null | wc -l || echo "0")
          echo "Total JS files: $JS_COUNT"
          if [ "$JS_COUNT" -gt 0 ]; then
            echo "All JavaScript files:"
            find android/app/src/main/assets/public -name "*.js" -ls 2>/dev/null || true
          else
            echo "‚ö†Ô∏è No JavaScript files found!"
          fi
          
          echo ""
          echo "=== 8. COMPLETE index.html Content ==="
          if [ -f "android/app/src/main/assets/public/index.html" ]; then
            echo "--- Full index.html ---"
            cat android/app/src/main/assets/public/index.html
          else
            echo "‚ùå index.html not found"
          fi
          
          echo ""
          echo "=== 9. App Icons Complete Check ==="
          echo "Checking all mipmap directories:"
          ls -lhR android/app/src/main/res/mipmap-* 2>/dev/null || echo "‚ö†Ô∏è No custom icons"
          
          echo ""
          echo "=== 10. COMPLETE build.gradle ==="
          if [ -f "android/app/build.gradle" ]; then
            echo "--- Full build.gradle ---"
            cat android/app/build.gradle
          else
            echo "‚ùå build.gradle not found"
          fi
          
          echo ""
          echo "=== 11. Package Name Verification ==="
          echo "From capacitor.config.ts:"
          grep "appId" capacitor.config.ts || true
          echo ""
          echo "From AndroidManifest.xml:"
          grep "package=" android/app/src/main/AndroidManifest.xml 2>/dev/null || true
          echo ""
          echo "From build.gradle:"
          grep "applicationId" android/app/build.gradle 2>/dev/null || true
          
          echo ""
          echo "=== 12. Resource Files Check ==="
          echo "CSS files:"
          find android/app/src/main/assets/public -name "*.css" -ls 2>/dev/null || true
          echo ""
          echo "Font files:"
          find android/app/src/main/assets/public -name "*.ttf" 2>/dev/null || true
          find android/app/src/main/assets/public -name "*.woff*" 2>/dev/null || true
          echo ""
          echo "Image files:"
          find android/app/src/main/assets/public -name "*.png" 2>/dev/null || true
          find android/app/src/main/assets/public -name "*.jpg" 2>/dev/null || true
          find android/app/src/main/assets/public -name "*.svg" 2>/dev/null || true
          find android/app/src/main/assets/public -name "*.ico" 2>/dev/null || true
          
          echo ""
          echo "======================================"
          set -e

      - name: Prepare release keystore with caching
        run: |
          mkdir -p .github/cache
          
          if [ -n "${{ secrets.SIGN_KEYSTORE_BASE64 }}" ]; then
            echo "Using Secrets keystore (official release)"
            echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
            cat > android/key.properties << 'KEYEOF'
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          KEYEOF
            echo "‚úÖ Release keystore configured"
          else
            if [ -f ".github/cache/upload-keystore.jks" ]; then
              echo "‚úÖ Reusing cached auto-generated keystore (supports upgrade)"
              cp .github/cache/upload-keystore.jks android/app/upload-keystore.jks
            else
              echo "üîë Generating new auto-keystore (first build)"
              keytool -genkey -v -keystore android/app/upload-keystore.jks \
                -keyalg RSA -keysize 2048 -validity 10000 \
                -storepass android -keypass android -alias androiddebugkey \
                -dname "CN=Chatbox Auto Build,O=Chatbox,C=CN"
              cp android/app/upload-keystore.jks .github/cache/upload-keystore.jks
              echo "üíæ Cached keystore for future builds"
            fi
            
            cat > android/key.properties << 'KEYEOF'
          storeFile=upload-keystore.jks
          storePassword=android
          keyAlias=androiddebugkey
          keyPassword=android
          KEYEOF
            echo "‚úÖ Auto keystore configured (upgradeable)"
          fi
          
          echo ""
          echo "Keystore info:"
          keytool -list -v -keystore android/app/upload-keystore.jks -storepass android 2>/dev/null || \
          keytool -list -v -keystore android/app/upload-keystore.jks -storepass "${{ secrets.KEYSTORE_PASSWORD }}" 2>/dev/null || \
          echo "‚ö†Ô∏è Cannot display keystore info"

      - name: Configure build for arm64 and signing
        run: |
          rm -f android/app/arm64-config.gradle || true
          
          cat > android/app/arm64-config.gradle << 'GRADLEEOF'
          def keystoreFile = rootProject.file('key.properties')
          def keystoreProps = new Properties()
          def hasKeystore = keystoreFile.exists()
          if (hasKeystore) {
              keystoreProps.load(new FileInputStream(keystoreFile))
          }
          
          android {
              splits {
                  abi {
                      enable false
                  }
                  density {
                      enable false
                  }
              }
              
              defaultConfig {
                  ndk {
                      abiFilters "arm64-v8a"
                  }
              }
              
              if (hasKeystore) {
                  signingConfigs {
                      release {
                          storeFile file(keystoreProps['storeFile'])
                          storePassword keystoreProps['storePassword']
                          keyAlias keystoreProps['keyAlias']
                          keyPassword keystoreProps['keyPassword']
                      }
                  }
                  
                  buildTypes {
                      release {
                          signingConfig signingConfigs.release
                      }
                  }
              }
          }
          GRADLEEOF
          
          if ! grep -q "apply from: 'arm64-config.gradle'" android/app/build.gradle 2>/dev/null; then
            echo "" >> android/app/build.gradle
            echo "apply from: 'arm64-config.gradle'" >> android/app/build.gradle
          fi
          
          echo "‚úÖ Build configuration applied"

      - name: Make gradlew executable
        run: chmod +x android/gradlew || true

      - name: Build release APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace --build-cache
          cd ..

      - name: Package and rename APK
        id: apk
        run: |
          APK="android/app/build/outputs/apk/release/app-release.apk"
          if [ ! -f "$APK" ]; then
            APK=$(find android/app/build/outputs/apk/release -type f -name "*-release.apk" ! -name "*unsigned*" 2>/dev/null | head -1 || true)
          fi
          
          if [ -z "$APK" ] || [ ! -f "$APK" ]; then
            echo "::error::APK not found"
            echo "Available files:"
            find android/app/build/outputs -type f 2>/dev/null || true
            exit 1
          fi
          
          VER=$(node -p "require('./package.json').version")
          PROD=$(node -p "require('./package.json').productName||'chatbox'")
          NAME="${PROD}-android-${VER}-arm64-v8a.apk"
          
          mkdir -p artifacts
          cp "$APK" "artifacts/$NAME"
          
          echo "apk_name=$NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Packaged: $NAME ($(ls -lh artifacts/$NAME | awk '{print $5}'))"
          
          echo ""
          echo "APK Details:"
          file "artifacts/$NAME" 2>/dev/null || true
          if command -v aapt >/dev/null 2>&1; then
            aapt dump badging "artifacts/$NAME" 2>/dev/null | grep -E "package:|sdkVersion:|targetSdkVersion:|native-code:" || true
          else
            echo "‚ö†Ô∏è aapt not available, skipping detailed APK analysis"
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-arm64-v8a
          path: artifacts/${{ steps.apk.outputs.apk_name }}
          if-no-files-found: error
