name: Build Chatbox Android APK (arm64-v8a)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"

jobs:
  build-android-arm64:
    name: Build Android (arm64-v8a)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Create capacitor.config.ts
        run: |
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'xyz.chatboxapp.ce',
            appName: 'Chatbox',
            webDir: 'release/app/dist/renderer',
            plugins: { CapacitorHttp: { enabled: true } },
          };
          export default config;
          EOF

      - name: Install dependencies (ignore scripts)
        run: npm install --ignore-scripts

      - name: Apply dependency patches
        run: npx patch-package

      - name: Add Android platform
        run: npx cap add android
      
      - name: Setup Java JDK 17 and Gradle Cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Cache Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            android/gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/daemon
          key: ${{ runner.os }}-gradle-deps-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-deps-

      - name: Cache Gradle Build Cache
        uses: actions/cache@v4
        with:
          path: |
            android/.gradle
            android/app/build
          key: ${{ runner.os }}-gradle-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-gradle-build-

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_HOME }}/platforms
            ${{ env.ANDROID_HOME }}/build-tools
            ${{ env.ANDROID_HOME }}/platform-tools
            ${{ env.ANDROID_HOME }}/cmdline-tools
          key: ${{ runner.os }}-android-sdk-${{ hashFiles('android/app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Accept Android SDK Licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Build web assets for Mobile
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          export CHATBOX_BUILD_PLATFORM=android
          npm run build:renderer

      - name: Verify build output exists
        run: |
          if [ ! -d "release/app/dist/renderer" ]; then
            echo "::error::Build output not found!"
            exit 1
          fi
          ls -la release/app/dist/renderer/

      - name: Delete source maps
        run: find ./release/app/dist/renderer -type f -name "*.map" -delete 2>/dev/null || true

      - name: Sync Capacitor assets
        run: npx cap sync android

      - name: Prepare release keystore
        run: |
          set -e
          if [ -n "${{ secrets.SIGN_KEYSTORE_BASE64 }}" ]; then
            echo "Using secrets for release signing."
            echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
            cat > android/key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
          else
            echo "Generating temporary keystore."
            keytool -genkey -v -keystore android/app/upload-keystore.jks \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass android -keypass android \
              -alias androiddebugkey \
              -dname "CN=Android Debug, O=Android, C=US"
            cat > android/key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=android
          keyAlias=androiddebugkey
          keyPassword=android
          EOF
          fi

      - name: Configure build.gradle for arm64 and signing
        run: |
          BUILD_GRADLE="android/app/build.gradle"
          
          # 1. 在文件顶部添加读取 key.properties 的逻辑
          cat > "${BUILD_GRADLE}.tmp" << 'HEADER_EOF'
          def keystorePropertiesFile = rootProject.file('key.properties')
          def keystoreProperties = new Properties()
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
          }
          
          HEADER_EOF
          cat "$BUILD_GRADLE" >> "${BUILD_GRADLE}.tmp"
          mv "${BUILD_GRADLE}.tmp" "$BUILD_GRADLE"
          
          # 2. 在 android { 后面立即插入 ndk 和 splits 配置（不使用 afterEvaluate）
          sed -i '/^android {/a\
              splits {\
                  abi {\
                      enable false\
                  }\
                  density {\
                      enable false\
                  }\
              }' "$BUILD_GRADLE"
          
          # 3. 在 defaultConfig 中添加 ndk.abiFilters
          sed -i '/defaultConfig {/a\
              ndk {\
                  abiFilters "arm64-v8a"\
              }' "$BUILD_GRADLE"
          
          # 4. 在 android { 后添加签名配置
          sed -i '/^android {/a\
              if (keystorePropertiesFile.exists()) {\
                  signingConfigs {\
                      release {\
                          storeFile file(keystoreProperties["storeFile"])\
                          storePassword keystoreProperties["storePassword"]\
                          keyAlias keystoreProperties["keyAlias"]\
                          keyPassword keystoreProperties["keyPassword"]\
                      }\
                  }\
              }' "$BUILD_GRADLE"
          
          # 5. 修改 release buildType 使用签名
          sed -i '/buildTypes {/,/release {/{
              /release {/a\
                  if (keystorePropertiesFile.exists()) {\
                      signingConfig signingConfigs.release\
                  }
          }' "$BUILD_GRADLE"
          
          echo "build.gradle configured successfully"

      - name: Build arm64-v8a APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace --build-cache
          cd ..
      
      - name: Find and Rename APK
        id: find_apk
        run: |
          set -e
          
          STANDARD_APK="android/app/build/outputs/apk/release/app-release.apk"
          
          if [ -f "$STANDARD_APK" ]; then
            APK_PATH="$STANDARD_APK"
          else
            APK_PATH=$(find android/app/build/outputs/apk/release -type f \
              \( -name "app-release.apk" -o -name "*-release.apk" \) \
              ! -name "*unsigned*" | head -n 1)
            
            if [ -z "$APK_PATH" ]; then
              echo "::error::APK not found!"
              find android/app/build/outputs -type f
              exit 1
            fi
          fi
          
          echo "Found APK: $APK_PATH"
          VERSION=$(node -p "require('./package.json').version")
          mkdir -p artifacts
          PRODUCT_NAME=$(node -p "require('./package.json').productName || 'chatbox'")
          NEW_NAME="${PRODUCT_NAME}-android-${VERSION}-arm64-v8a.apk"
          cp "$APK_PATH" "artifacts/$NEW_NAME"
          echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-arm64-v8a
          path: artifacts/${{ steps.find_apk.outputs.apk_name }}
          if-no-files-found: error
