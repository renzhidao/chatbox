name: Build Chatbox Android APK (Ultimate Debug Edition)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"

jobs:
  build-android-arm64-debug:
    name: Build Android for Debug (arm64-v8a)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      # ... (前面和原来一样的缓存、配置步骤，为简洁省略，下面是核心修改) ...

      - name: Install dependencies and Sharp
        run: |
          npm install --ignore-scripts
          npx patch-package || echo "::warning::Patch warnings"
          if npm install sharp; then
            npm rebuild sharp || echo "::warning::Sharp rebuild failed"
          else
            echo "::warning::Sharp install failed"
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Create debug-bridge.js for WebView injection
        run: |
          mkdir -p android/app/src/main/assets
          cat > android/app/src/main/assets/debug-bridge.js << 'JS_EOF'
          // Injected Debug Bridge v1.0
          (function() {
              if (window.__DEBUG_BRIDGE_INITIALIZED__) return;
              window.__DEBUG_BRIDGE_INITIALIZED__ = true;
          
              // 1. 捕获所有 console 输出
              const originalConsole = { ...window.console };
              const logToNative = (level, args) => {
                  try {
                      const message = args.map(arg => {
                          if (arg instanceof Error) return arg.stack;
                          if (typeof arg === 'object') return JSON.stringify(arg);
                          return String(arg);
                      }).join(' ');
                      
                      if (window.AndroidBridge && typeof window.AndroidBridge.log === 'function') {
                          window.AndroidBridge.log(`JS_CONSOLE_${level.toUpperCase()}: ${message}`);
                      } else {
                          originalConsole.log(`(Native bridge not ready) ${level}: ${message}`);
                      }
                  } catch (e) {
                      originalConsole.error('Debug bridge failed:', e);
                  }
              };
          
              Object.keys(originalConsole).forEach(level => {
                  if (typeof originalConsole[level] === 'function') {
                      window.console[level] = (...args) => {
                          originalConsole[level](...args);
                          logToNative(level, args);
                      };
                  }
              });
          
              // 2. 捕获所有 fetch 请求
              const originalFetch = window.fetch;
              window.fetch = function(...args) {
                  try {
                      const url = args[0] instanceof Request ? args[0].url : String(args[0]);
                      const method = (args[0] instanceof Request ? args[0].method : (args[1]?.method || 'GET')).toUpperCase();
                      logToNative('fetch', [`--> ${method} ${url}`]);
                  } catch {}
                  
                  return originalFetch.apply(this, args).then(response => {
                      logToNative('fetch', [`<-- ${response.status} ${response.url}`]);
                      return response;
                  }).catch(error => {
                      logToNative('error', [`FETCH_ERROR: ${error.message}`]);
                      throw error;
                  });
              };
          
              console.log('✅ Injected Debug Bridge is active. All console logs and fetch requests are being monitored.');
          })();
          JS_EOF
          echo "✅ Created debug-bridge.js"

      - name: Inject Ultimate Debug MainActivity.java
        run: |
          MAIN_JAVA="android/app/src/main/java/xyz/chatboxapp/ce/MainActivity.java"
          mkdir -p "$(dirname "$MAIN_JAVA")"
          
          cat > "$MAIN_JAVA" << 'JAVA_EOF'
          package xyz.chatboxapp.ce;
          
          import android.Manifest;
          import android.content.Context;
          import android.content.pm.PackageManager;
          import android.os.Build;
          import android.os.Bundle;
          import android.os.Environment;
          import android.webkit.JavascriptInterface;
          import android.webkit.ConsoleMessage;
          import android.webkit.WebChromeClient;
          import android.webkit.WebView;
          import androidx.core.app.ActivityCompat;
          import androidx.core.content.ContextCompat;
          import com.getcapacitor.BridgeActivity;
          import java.io.File;
          import java.io.FileWriter;
          import java.io.IOException;
          import java.io.PrintWriter;
          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.Locale;
          
          public class MainActivity extends BridgeActivity {
              private static final int REQUEST_STORAGE_PERMISSIONS = 1001;
              private boolean hasStoragePermission = false;
          
              // 日志文件路径
              private File publicLogFile;
              private File privateExternalLogFile;
              private File privateInternalLogFile;
          
              // 日志记录的核心方法
              private synchronized void writeToLogs(String message) {
                  String timestamp = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS", Locale.getDefault()).format(new Date());
                  String logLine = timestamp + " " + message;
                  
                  // 打印到 Logcat (系统日志)
                  android.util.Log.d("ChatboxUltimateDebug", message);
                  
                  if (!hasStoragePermission) return;
          
                  // 同时写入三个文件
                  writeLogToFile(publicLogFile, logLine);
                  writeLogToFile(privateExternalLogFile, logLine);
                  writeLogToFile(privateInternalLogFile, logLine);
              }
          
              private void writeLogToFile(File file, String logLine) {
                  if (file == null) return;
                  try (FileWriter fw = new FileWriter(file, true);
                       PrintWriter pw = new PrintWriter(fw)) {
                      pw.println(logLine);
                  } catch (IOException e) {
                      android.util.Log.e("ChatboxUltimateDebug", "Failed to write to " + file.getAbsolutePath(), e);
                  }
              }
          
              // 权限检查与请求
              private void checkAndRequestPermissions() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
                      // Android 11+，不再需要 WRITE_EXTERNAL_STORAGE
                      hasStoragePermission = true;
                      writeToLogs("INFO: Android 11+ storage permission is implicitly granted for app-specific directories.");
                      return;
                  }
          
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
                      ActivityCompat.requestPermissions(this, new String[]{
                          Manifest.permission.READ_EXTERNAL_STORAGE,
                          Manifest.permission.WRITE_EXTERNAL_STORAGE
                      }, REQUEST_STORAGE_PERMISSIONS);
                  } else {
                      hasStoragePermission = true;
                  }
              }
          
              @Override
              public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
                  super.onRequestPermissionsResult(requestCode, permissions, grantResults);
                  if (requestCode == REQUEST_STORAGE_PERMISSIONS) {
                      if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                          hasStoragePermission = true;
                          writeToLogs("INFO: Storage permission granted by user.");
                          initializeLogFiles(); // 权限获取后再次初始化
                      } else {
                          writeToLogs("ERROR: Storage permission DENIED by user. Logging to files will fail.");
                      }
                  }
              }
          
              private void initializeLogFiles() {
                  if (hasStoragePermission) {
                      // 公共目录
                      publicLogFile = new File(Environment.getExternalStorageDirectory(), "chatbox_public_debug.log");
                      // 私有外部目录
                      File externalDir = getExternalFilesDir(null);
                      if (externalDir != null) {
                          privateExternalLogFile = new File(externalDir, "chatbox_private_external.log");
                      }
                      // 私有内部目录
                      privateInternalLogFile = new File(getFilesDir(), "chatbox_private_internal.log");
                      
                      writeToLogs("INFO: Log files initialized.");
                      writeToLogs(" - Public: " + (publicLogFile != null ? publicLogFile.getAbsolutePath() : "N/A"));
                      writeToLogs(" - Private External: " + (privateExternalLogFile != null ? privateExternalLogFile.getAbsolutePath() : "N/A"));
                      writeToLogs(" - Private Internal: " + (privateInternalLogFile != null ? privateInternalLogFile.getAbsolutePath() : "N/A"));
                  }
              }
              
              // 提供给 JavaScript 调用的接口
              public class AndroidBridge {
                  @JavascriptInterface
                  public void log(String message) {
                      writeToLogs("JS_BRIDGE: " + message);
                  }
              }
          
              @Override
              public void onCreate(Bundle savedInstanceState) {
                  checkAndRequestPermissions();
                  initializeLogFiles();
                  
                  writeToLogs("=== MainActivity onCreate START (Ultimate Debug) ===");
                  writeToLogs("Android Version: " + Build.VERSION.SDK_INT);
          
                  super.onCreate(savedInstanceState);
                  
                  WebView webView = bridge.getWebView();
                  if (webView != null) {
                      WebView.setWebContentsDebuggingEnabled(true);
                      webView.getSettings().setJavaScriptEnabled(true);
                      webView.addJavascriptInterface(new AndroidBridge(), "AndroidBridge");
                      
                      // 注入 JS 调试桥
                      try {
                          java.io.InputStream is = getAssets().open("debug-bridge.js");
                          byte[] buffer = new byte[is.available()];
                          is.read(buffer);
                          is.close();
                          String js = new String(buffer, "UTF-8");
                          webView.evaluateJavascript(js, null);
                          writeToLogs("INFO: Injected debug-bridge.js into WebView.");
                      } catch (Exception e) {
                          writeToLogs("ERROR: Failed to inject debug-bridge.js: " + e.getMessage());
                      }
                      
                      webView.setWebChromeClient(new WebChromeClient() {
                          @Override
                          public boolean onConsoleMessage(ConsoleMessage cm) {
                              // 这个日志现在由 JS Bridge 捕获，这里可以保留作为备用
                              // writeToLogs("NATIVE_CONSOLE: [" + cm.messageLevel() + "] " + cm.message());
                              return true;
                          }
                      });
                  } else {
                       writeToLogs("ERROR: Bridge or WebView is null during onCreate!");
                  }
                  writeToLogs("=== MainActivity onCreate COMPLETE ===");
              }
          }
          JAVA_EOF
          echo "✅ MainActivity injected with Ultimate Debug capabilities."

      - name: Fix AndroidManifest.xml for full permissions and network
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          # 1. 添加所有必要的权限
          sed -i '/<manifest/a\
              <uses-permission android:name="android.permission.INTERNET" />\
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />\
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="29" />\
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />\
              <uses-permission android:name="android.permission.READ_CLIPBOARD" />' "$MANIFEST"
          echo "✅ Added all necessary permissions to AndroidManifest.xml"

          # 2. 添加网络安全配置 (允许所有 http 流量)
          sed -i '/<application/a\        android:usesCleartextTraffic="true"\
              android:networkSecurityConfig="@xml/network_security_config"' "$MANIFEST"
          NSC_FILE="android/app/src/main/res/xml/network_security_config.xml"
          mkdir -p "$(dirname "$NSC_FILE")"
          echo '<?xml version="1.0" encoding="utf-8"?><network-security-config><base-config cleartextTrafficPermitted="true"><trust-anchors><certificates src="system" /></trust-anchors></base-config></network-security-config>' > "$NSC_FILE"
          echo "✅ Added permissive network security config"
      
      # ... (后续的 build, package, upload 步骤和原来一样，为简洁省略) ...

      - name: Build web assets
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          export NODE_ENV=production
          npm run build:renderer
      - name: Sync Capacitor assets
        run: npx cap sync android
      - name: Build release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace
          cd ..
      - name: Package and Upload APK
        run: |
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*-release.apk" | head -1)
          [ -f "$APK_PATH" ] || { echo "::error::APK not found"; exit 1; }
          VERSION=$(node -p "require('./package.json').version")
          NAME="Chatbox-Debug-${VERSION}-arm64.apk"
          mkdir -p artifacts
          cp "$APK_PATH" "artifacts/$NAME"
          echo "✅ Packaged as $NAME"
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-debug-apk
          path: artifacts/Chatbox-Debug-*-arm64.apk
