name: Build Chatbox Android APK (arm64-v8a)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"

jobs:
  build-android-arm64:
    name: Build Android (arm64-v8a)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Create capacitor.config.ts
        run: |
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          
          const config: CapacitorConfig = {
            appId: 'xyz.chatboxapp.ce',
            appName: 'Chatbox',
            webDir: 'release/app/dist/renderer',
            plugins: {
              CapacitorHttp: { enabled: true },
            },
          };
          
          export default config;
          EOF
          echo "✅ Created capacitor.config.ts"

      - name: Install dependencies (without scripts)
        run: npm install --ignore-scripts

      - name: Apply patches
        run: npx patch-package || echo "::warning::Patch warnings (non-critical)"

      - name: Install and verify Sharp
        run: |
          echo "Installing Sharp..."
          if npm install sharp; then
            echo "Rebuilding Sharp native bindings..."
            npm rebuild sharp || echo "::warning::Sharp rebuild failed"
            
            echo "Verifying Sharp..."
            if node -e "require('sharp')" 2>/dev/null; then
              echo "✅ Sharp is ready"
            else
              echo "::warning::Sharp verification failed - will use default icons"
            fi
          else
            echo "::warning::Sharp install failed - will use default icons"
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Inject comprehensive debug logging to MainActivity
        run: |
          MAIN_JAVA="android/app/src/main/java/xyz/chatboxapp/ce/MainActivity.java"
          
          mkdir -p "$(dirname "$MAIN_JAVA")"
          
          cat > "$MAIN_JAVA" << 'JAVA_EOF'
          package xyz.chatboxapp.ce;
          
          import android.os.Bundle;
          import android.util.Log;
          import android.webkit.ConsoleMessage;
          import android.webkit.WebChromeClient;
          import android.webkit.WebView;
          import com.getcapacitor.BridgeActivity;
          import java.io.File;
          import java.io.FileWriter;
          import java.io.PrintWriter;
          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.Locale;
          
          public class MainActivity extends BridgeActivity {
              private static final String TAG = "ChatboxDebug";
              private File logFile;
              
              private void log(String message) {
                  Log.d(TAG, message);
                  
                  try {
                      if (logFile == null) {
                          File logDir = getExternalFilesDir(null);
                          if (logDir != null) {
                              logFile = new File(logDir, "chatbox_debug.log");
                          }
                      }
                      
                      if (logFile != null) {
                          String timestamp = new SimpleDateFormat("HH:mm:ss.SSS", Locale.getDefault()).format(new Date());
                          FileWriter fw = new FileWriter(logFile, true);
                          PrintWriter pw = new PrintWriter(fw);
                          pw.println(timestamp + " " + message);
                          pw.close();
                      }
                  } catch (Exception e) {
                      Log.e(TAG, "Failed to write to file: " + e.getMessage());
                  }
              }
              
              @Override
              public void onCreate(Bundle savedInstanceState) {
                  log("========================================");
                  log("=== MainActivity onCreate START ===");
                  log("Android Version: " + android.os.Build.VERSION.SDK_INT);
                  log("Package: xyz.chatboxapp.ce");
                  
                  File logDir = getExternalFilesDir(null);
                  if (logDir != null) {
                      log("Log file path: " + logDir.getAbsolutePath() + "/chatbox_debug.log");
                  }
                  
                  try {
                      log("Calling super.onCreate()...");
                      super.onCreate(savedInstanceState);
                      log("✅ super.onCreate() completed");
                      
                      if (bridge != null) {
                          log("✅ Bridge initialized");
                          
                          if (bridge.getWebView() != null) {
                              WebView webView = bridge.getWebView();
                              log("✅ WebView obtained");
                              
                              WebView.setWebContentsDebuggingEnabled(true);
                              log("✅ WebView debugging enabled");
                              
                              webView.setWebChromeClient(new WebChromeClient() {
                                  @Override
                                  public boolean onConsoleMessage(ConsoleMessage cm) {
                                      log("WebView Console [" + cm.messageLevel() + "]: " + cm.message() + 
                                          " -- Line " + cm.lineNumber() + " of " + cm.sourceId());
                                      return true;
                                  }
                                  
                                  @Override
                                  public void onProgressChanged(WebView view, int newProgress) {
                                      log("WebView loading progress: " + newProgress + "%");
                                  }
                              });
                              log("✅ WebChromeClient configured");
                              
                              String url = webView.getUrl();
                              log("WebView current URL: " + (url != null ? url : "null"));
                          } else {
                              log("❌ WARNING: WebView is null!");
                          }
                      } else {
                          log("❌ WARNING: Bridge is null!");
                      }
                      
                      log("=== MainActivity onCreate COMPLETE ===");
                  } catch (Exception e) {
                      log("❌ ERROR in onCreate: " + e.getMessage());
                      log("Stack trace: " + Log.getStackTraceString(e));
                      throw e;
                  }
              }
              
              @Override
              public void onStart() {
                  log("=== onStart ===");
                  super.onStart();
              }
              
              @Override
              public void onResume() {
                  log("=== onResume ===");
                  super.onResume();
                  
                  if (bridge != null && bridge.getWebView() != null) {
                      String url = bridge.getWebView().getUrl();
                      log("WebView URL after resume: " + (url != null ? url : "null"));
                  }
              }
              
              @Override
              public void onPause() {
                  log("=== onPause ===");
                  super.onPause();
              }
              
              @Override
              public void onDestroy() {
                  log("=== onDestroy ===");
                  super.onDestroy();
              }
          }
          JAVA_EOF
          
          echo "✅ MainActivity with dual logging"
      
      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Cache Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            android/gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/daemon
          key: ${{ runner.os }}-gradle-deps-${{ hashFiles('android/**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-deps-

      - name: Cache Gradle Build
        uses: actions/cache@v4
        with:
          path: |
            android/.gradle
            android/app/build
          key: ${{ runner.os }}-gradle-build-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-build-

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_HOME }}/platforms
            ${{ env.ANDROID_HOME }}/build-tools
          key: ${{ runner.os }}-android-sdk
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Cache auto-generated keystore
        uses: actions/cache@v4
        with:
          path: .github/cache/upload-keystore.jks
          key: ${{ runner.os }}-auto-keystore
          restore-keys: |
            ${{ runner.os }}-auto-keystore

      - name: Generate Android assets
        run: npx capacitor-assets generate --android || echo "::warning::Asset generation failed, using defaults"

      - name: Accept SDK Licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Patch webpack config for mobile build
        run: |
          WEBPACK_CONFIG=".erb/configs/webpack.config.renderer.prod.ts"
          
          cp "$WEBPACK_CONFIG" "${WEBPACK_CONFIG}.backup"
          
          sed -i "s/target: \['web', 'electron-renderer'\]/target: process.env.CHATBOX_BUILD_TARGET === 'mobile_app' ? ['web'] : ['web', 'electron-renderer']/" "$WEBPACK_CONFIG"
          
          echo "✅ Webpack config patched for mobile build"
          echo ""
          echo "Modified target line:"
          grep "target:" "$WEBPACK_CONFIG" | head -1

      - name: Prepare build directories and copy static assets
        run: |
          echo "Creating build directories..."
          mkdir -p release/app/dist/renderer/static/icons/providers
          mkdir -p release/app/dist/renderer/static/icons
          mkdir -p release/app/dist/renderer/static/fonts
          mkdir -p release/app/dist/renderer/static/logos
          
          echo "Copying static assets..."
          if [ -d "src/renderer/static" ]; then
            # 复制所有静态资源
            cp -r src/renderer/static/* release/app/dist/renderer/static/ 2>/dev/null || true
            
            echo "✅ Static assets copied"
            echo ""
            echo "Provider icons:"
            ls -la release/app/dist/renderer/static/icons/providers/ 2>/dev/null || echo "No provider icons found"
            echo ""
            echo "Static structure:"
            find release/app/dist/renderer/static -type f | head -20
          else
            echo "::warning::Static directory not found at src/renderer/static"
          fi

      - name: Build web assets
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          export CHATBOX_BUILD_PLATFORM=android
          export NODE_ENV=production
          export TS_NODE_TRANSPILE_ONLY=true
          npm run build:renderer

      - name: Verify build output and copy missing static assets
        run: |
          [ -d "release/app/dist/renderer" ] || { echo "::error::Build directory missing"; exit 1; }
          [ -f "release/app/dist/renderer/index.html" ] || { echo "::error::index.html missing"; exit 1; }
          
          # 确保静态资源在构建后仍然存在
          if [ -d "src/renderer/static" ] && [ ! -d "release/app/dist/renderer/static/icons/providers" ]; then
            echo "Re-copying static assets after build..."
            mkdir -p release/app/dist/renderer/static
            cp -r src/renderer/static/* release/app/dist/renderer/static/
          fi
          
          echo "✅ Build verified ($(du -sh release/app/dist/renderer | cut -f1))"
          echo ""
          echo "Final provider icons check:"
          ls -la release/app/dist/renderer/static/icons/providers/ 2>/dev/null || echo "::warning::No provider icons in final build"

      - name: Fix HTML for mobile (remove scripts & fix placeholders)
        run: |
          set -e
          
          echo "Removing source maps..."
          find ./release/app/dist/renderer -name "*.map" -delete 2>/dev/null || true
          
          INDEX_HTML="release/app/dist/renderer/index.html"
          if [ -f "$INDEX_HTML" ]; then
            echo "Processing index.html for mobile compatibility..."
            cp "$INDEX_HTML" "${INDEX_HTML}.backup"
            
            python3 << 'PYTHON_EOF'
          import re
          import sys
          
          try:
              html_file = 'release/app/dist/renderer/index.html'
              
              with open(html_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              if not content:
                  print("ERROR: index.html is empty", file=sys.stderr)
                  sys.exit(1)
              
              original_size = len(content)
              
              # 1. 替换 %PUBLIC_URL% 占位符
              public_url_count = content.count('%PUBLIC_URL%')
              content = content.replace('%PUBLIC_URL%', '.')
              
              # 2. 删除外部分析脚本
              patterns = [
                  r'<script async src="https://www\.googletagmanager\.com/gtag/js[^"]*"></script>',
                  r'<script\s+defer[^>]*plausible\.midway\.run[^>]*></script>',
                  r'<script>window\.plausible\s*=[\s\S]*?</script>',
              ]
              
              for pattern in patterns:
                  content = re.sub(pattern, '', content, flags=re.DOTALL)
              
              with open(html_file, 'w', encoding='utf-8') as f:
                  f.write(content)
              
              removed_size = original_size - len(content)
              print(f"✅ HTML processed")
              print(f"   %PUBLIC_URL% replaced: {public_url_count}")
              print(f"   Size: {original_size} → {len(content)} bytes (-{removed_size})")
              
          except Exception as e:
              print(f"ERROR: {e}", file=sys.stderr)
              sys.exit(1)
          PYTHON_EOF
            
            if grep -q "%PUBLIC_URL%" "$INDEX_HTML"; then
              echo "::error::%PUBLIC_URL% still present!"
              exit 1
            fi
            echo "✅ Verification passed"
          else
            echo "::error::index.html not found!"
            exit 1
          fi

      - name: Sync Capacitor assets
        run: npx cap sync android

      - name: Fix AndroidManifest.xml and add network security config
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          cp "$MANIFEST" "${MANIFEST}.backup"
          
          # 1. 添加 usesCleartextTraffic
          if ! grep -q 'android:usesCleartextTraffic' "$MANIFEST"; then
            sed -i '/<application/a\        android:usesCleartextTraffic="true"' "$MANIFEST"
            echo "✅ Added usesCleartextTraffic=true"
          fi
          
          # 2. 添加 networkSecurityConfig
          if ! grep -q 'android:networkSecurityConfig' "$MANIFEST"; then
            sed -i '/<application/a\        android:networkSecurityConfig="@xml/network_security_config"' "$MANIFEST"
            echo "✅ Added networkSecurityConfig"
          fi
          
          # 3. 添加剪贴板权限
          if ! grep -q 'android.permission.READ_CLIPBOARD' "$MANIFEST"; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.READ_CLIPBOARD" />' "$MANIFEST"
            echo "✅ Added READ_CLIPBOARD permission"
          fi
          
          # 4. 创建网络安全配置文件
          NSC_DIR="android/app/src/main/res/xml"
          NSC_FILE="$NSC_DIR/network_security_config.xml"
          
          mkdir -p "$NSC_DIR"
          
          cat > "$NSC_FILE" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <network-security-config>
              <domain-config cleartextTrafficPermitted="true">
                  <domain includeSubdomains="true">127.0.0.1</domain>
                  <domain includeSubdomains="true">localhost</domain>
                  <domain includeSubdomains="true">10.0.2.2</domain>
              </domain-config>
          </network-security-config>
          XML_EOF
          
          echo "✅ Created network_security_config.xml"
          echo ""
          echo "=== AndroidManifest.xml application tag ==="
          grep -A5 '<application' "$MANIFEST" | head -8

      - name: Verify Capacitor sync
        run: |
          ASSETS="android/app/src/main/assets"
          DIR="$ASSETS/public"
          [ -d "$DIR" ] || DIR="$ASSETS/www"
          [ -d "$DIR" ] || { echo "::error::Assets not found"; exit 1; }
          [ -f "$DIR/index.html" ] || { echo "::error::index.html not synced"; exit 1; }
          
          if grep -q "%PUBLIC_URL%" "$DIR/index.html"; then
            echo "::error::%PUBLIC_URL% in synced HTML!"
            exit 1
          fi
          echo "✅ Sync verified ($(du -sh "$DIR" | cut -f1))"

      - name: Prepare release keystore with caching
        run: |
          mkdir -p .github/cache
          
          if [ -n "${{ secrets.SIGN_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
            cat > android/key.properties << 'EOF'
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
            echo "✅ Release keystore"
          else
            if [ -f ".github/cache/upload-keystore.jks" ]; then
              cp .github/cache/upload-keystore.jks android/app/upload-keystore.jks
            else
              keytool -genkey -v -keystore android/app/upload-keystore.jks \
                -keyalg RSA -keysize 2048 -validity 10000 \
                -storepass android -keypass android -alias androiddebugkey \
                -dname "CN=Chatbox,O=Chatbox,C=CN"
              cp android/app/upload-keystore.jks .github/cache/upload-keystore.jks
            fi
            
            cat > android/key.properties << 'EOF'
          storeFile=upload-keystore.jks
          storePassword=android
          keyAlias=androiddebugkey
          keyPassword=android
          EOF
            echo "✅ Auto keystore"
          fi

      - name: Configure build for arm64 and signing
        run: |
          cat > android/app/arm64-config.gradle << 'EOF'
          def keystoreFile = rootProject.file('key.properties')
          def keystoreProps = new Properties()
          def hasKeystore = keystoreFile.exists()
          if (hasKeystore) {
              keystoreProps.load(new FileInputStream(keystoreFile))
          }
          
          android {
              splits {
                  abi { enable false }
                  density { enable false }
              }
              
              defaultConfig {
                  ndk { abiFilters "arm64-v8a" }
              }
              
              if (hasKeystore) {
                  signingConfigs {
                      release {
                          storeFile file(keystoreProps['storeFile'])
                          storePassword keystoreProps['storePassword']
                          keyAlias keystoreProps['keyAlias']
                          keyPassword keystoreProps['keyPassword']
                      }
                  }
                  
                  buildTypes {
                      release {
                          signingConfig signingConfigs.release
                      }
                  }
              }
          }
          EOF
          
          if ! grep -q "apply from: 'arm64-config.gradle'" android/app/build.gradle; then
            echo "" >> android/app/build.gradle
            echo "apply from: 'arm64-config.gradle'" >> android/app/build.gradle
          fi
          echo "✅ Build config"

      - name: Build release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace --build-cache
          cd ..

      - name: Package APK
        id: apk
        run: |
          APK="android/app/build/outputs/apk/release/app-release.apk"
          [ -f "$APK" ] || APK=$(find android/app/build/outputs/apk/release -name "*-release.apk" ! -name "*unsigned*" | head -1)
          [ -f "$APK" ] || { echo "::error::APK not found"; exit 1; }
          
          VER=$(node -p "require('./package.json').version")
          PROD=$(node -p "require('./package.json').productName||'chatbox'")
          NAME="${PROD}-android-${VER}-arm64-v8a.apk"
          
          mkdir -p artifacts
          cp "$APK" "artifacts/$NAME"
          
          echo "apk_name=$NAME" >> $GITHUB_OUTPUT
          echo "✅ $NAME ($(ls -lh artifacts/$NAME | awk '{print $5}'))"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-arm64-v8a
          path: artifacts/${{ steps.apk.outputs.apk_name }}
          if-no-files-found: error
