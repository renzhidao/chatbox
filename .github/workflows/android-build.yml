name: Build Chatbox Android APK (arm64-v8a)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"

jobs:
  build-android-arm64:
    name: Build Android (arm64-v8a)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Create capacitor.config.ts
        run: |
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'xyz.chatboxapp.ce',
            appName: 'Chatbox',
            webDir: 'dist',
            plugins: { CapacitorHttp: { enabled: true } },
          };
          export default config;
          EOF

      - name: Install dependencies (ignore scripts)
        run: npm install --ignore-scripts

      - name: Apply dependency patches
        run: npx patch-package

      - name: Add Android platform
        run: npx cap add android
      
      - name: Setup Java JDK 17 and Gradle Cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Accept Android SDK Licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Clean dist directory (use project script)
        run: npx ts-node ./.erb/scripts/clean.js dist

      - name: Build web assets for Mobile
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          export CHATBOX_BUILD_PLATFORM=android
          npm run build:renderer

      - name: Verify dist directory exists
        run: |
          if [ ! -d "dist" ]; then
            echo "::error::dist directory not found after build!"
            echo "Searching for build output..."
            find . -type d -name "dist" -o -name "build" -o -name "renderer" 2>/dev/null || true
            exit 1
          fi
          echo "dist directory exists, contents:"
          ls -la dist/

      - name: Delete source maps
        run: find ./dist -type f -name "*.map" -delete 2>/dev/null || true

      - name: Sync Capacitor assets
        run: npx cap sync android

      - name: Prepare release keystore
        run: |
          set -e
          if [ -n "${{ secrets.SIGN_KEYSTORE_BASE64 }}" ]; then
            echo "Using secrets for release signing."
            echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
            cat > android/key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
          else
            echo "Generating temporary keystore."
            keytool -genkey -v -keystore android/app/upload-keystore.jks \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass android -keypass android \
              -alias androiddebugkey \
              -dname "CN=Android Debug, O=Android, C=US"
            cat > android/key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=android
          keyAlias=androiddebugkey
          keyPassword=android
          EOF
          fi

      - name: Create custom build configuration
        run: |
          cat > android/app/custom-build.gradle << 'GRADLE_EOF'
          def keystorePropertiesFile = rootProject.file('key.properties')
          def keystoreProperties = new Properties()
          def hasKeystore = false
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
              hasKeystore = true
          }
          
          afterEvaluate {
              android {
                  defaultConfig {
                      ndk {
                          abiFilters "arm64-v8a"
                      }
                  }
                  
                  splits {
                      abi {
                          enable false
                      }
                      density {
                          enable false
                      }
                  }
              }
              
              if (hasKeystore) {
                  android {
                      signingConfigs {
                          release {
                              storeFile file(keystoreProperties['storeFile'])
                              storePassword keystoreProperties['storePassword']
                              keyAlias keystoreProperties['keyAlias']
                              keyPassword keystoreProperties['keyPassword']
                          }
                      }
                      buildTypes {
                          release {
                              signingConfig signingConfigs.release
                          }
                      }
                  }
              }
          }
          GRADLE_EOF
          
          echo "" >> android/app/build.gradle
          echo "apply from: 'custom-build.gradle'" >> android/app/build.gradle

      - name: Build arm64-v8a APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace
          cd ..
      
      - name: Find and Rename APK
        id: find_apk
        run: |
          set -e
          
          # 首先尝试标准的固定路径（最高效）
          STANDARD_APK="android/app/build/outputs/apk/release/app-release.apk"
          
          if [ -f "$STANDARD_APK" ]; then
            echo "Found APK at standard path: $STANDARD_APK"
            APK_PATH="$STANDARD_APK"
          else
            # 兜底：使用 find 搜索（容错处理）
            echo "Standard path not found, searching for APK..."
            APK_PATH=$(find android/app/build/outputs/apk/release -type f \
              \( -name "app-release.apk" -o -name "*-release.apk" \) \
              ! -name "*unsigned*" | head -n 1)
            
            if [ -z "$APK_PATH" ]; then
              echo "::error::APK not found! Available files:"
              find android/app/build/outputs -type f
              exit 1
            fi
            echo "Found APK via search: $APK_PATH"
          fi
          
          VERSION=$(node -p "require('./package.json').version")
          mkdir -p artifacts
          PRODUCT_NAME=$(node -p "require('./package.json').productName || 'chatbox'")
          NEW_NAME="${PRODUCT_NAME}-android-${VERSION}-arm64-v8a.apk"
          cp "$APK_PATH" "artifacts/$NEW_NAME"
          echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "APK packaged as: $NEW_NAME"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-arm64-v8a
          path: artifacts/${{ steps.find_apk.outputs.apk_name }}
          if-no-files-found: error
