name: Build Chatbox Android APK (main branch auto-trigger, original find logic)

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "doc/**"
      - "docs/**"
  workflow_dispatch:

jobs:
  build-android-arm64-final:
    name: Build Android (arm64-v8a) - Final Patched
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Create capacitor.config.ts
        run: |
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = { appId: 'xyz.chatboxapp.ce', appName: 'Chatbox', webDir: 'release/app/dist/renderer' };
          export default config;
          EOF

      - name: Install dependencies and patches
        run: |
          npm install --ignore-scripts
          npx patch-package || true

      - name: Install and verify Sharp
        run: |
          if ! npm install sharp; then
            echo "::warning::Sharp install failed, default icons will be used."
          else
            npm rebuild sharp || echo "::warning::Sharp rebuild failed."
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Inject Patched MainActivity for Logging
        run: |
          MAIN_JAVA="android/app/src/main/java/xyz/chatboxapp/ce/MainActivity.java"
          mkdir -p "$(dirname "$MAIN_JAVA")"
          cat > "$MAIN_JAVA" << 'JAVA_EOF'
          package xyz.chatboxapp.ce;
          import android.Manifest;
          import android.content.pm.PackageManager;
          import android.os.Build;
          import android.os.Bundle;
          import android.os.Environment;
          import android.webkit.ConsoleMessage;
          import android.webkit.WebChromeClient;
          import android.webkit.WebView;
          import androidx.core.app.ActivityCompat;
          import androidx.core.content.ContextCompat;
          import com.getcapacitor.BridgeActivity;
          import java.io.File;
          import java.io.FileWriter;
          import java.io.PrintWriter;
          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.Locale;
          
          public class MainActivity extends BridgeActivity {
              private static final int REQUEST_STORAGE_PERMISSION = 1001;
              private File logFile;

              private synchronized void log(String message) {
                  android.util.Log.d("ChatboxDebug", message);
                  if (logFile == null) return;
                  try (PrintWriter pw = new PrintWriter(new FileWriter(logFile, true))) {
                      String timestamp = new SimpleDateFormat("HH:mm:ss.SSS", Locale.getDefault()).format(new Date());
                      pw.println(timestamp + " " + message);
                  } catch (Exception e) {
                      android.util.Log.e("ChatboxDebug", "Failed to write log", e);
                  }
              }

              private void initializeLogFile() {
                  File targetDir = (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q)
                      ? getExternalFilesDir(null)
                      : Environment.getExternalStorageDirectory();
                  if (targetDir != null) {
                      logFile = new File(targetDir, "chatbox_debug.log");
                      log("Log file path set to: " + logFile.getAbsolutePath());
                  }
              }

              private void checkAndRequestPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q ||
                      ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED) {
                      initializeLogFile();
                  } else {
                      ActivityCompat.requestPermissions(this, new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE}, REQUEST_STORAGE_PERMISSION);
                  }
              }

              @Override
              public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
                  super.onRequestPermissionsResult(requestCode, permissions, grantResults);
                  if (requestCode == REQUEST_STORAGE_PERMISSION && grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                      initializeLogFile();
                  } else {
                      log("Storage permission denied. Logging to file is disabled.");
                  }
              }

              @Override
              public void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  checkAndRequestPermission();
                  WebView.setWebContentsDebuggingEnabled(true);
                  bridge.getWebView().setWebChromeClient(new WebChromeClient() {
                      @Override
                      public boolean onConsoleMessage(ConsoleMessage consoleMessage) {
                          log("WebView Console: " + consoleMessage.message() + " -- (" + consoleMessage.sourceId() + ":" + consoleMessage.lineNumber() + ")");
                          return true;
                      }
                  });
              }
          }
          JAVA_EOF

      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Patch webpack config for mobile build
        run: |
          sed -i "s/target: \['web', 'electron-renderer'\]/target: ['web']/" .erb/configs/webpack.config.renderer.prod.ts

      - name: Build web assets
        run: |
          export CHATBOX_BUILD_TARGET=mobile_app
          npm run build:renderer

      - name: Fix HTML for mobile
        run: |
          python3 -c "import re; f='release/app/dist/renderer/index.html'; c=open(f).read(); c=c.replace('%PUBLIC_URL%','.'); c=re.sub(r'<script[^>]*src=\"https://www\.googletagmanager\.com[^>]*></script>','',c); open(f,'w').write(c)"
      
      - name: Sync Capacitor assets
        run: npx cap sync android
        
      - name: Patch AndroidManifest and Network Config
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if ! grep -q 'android.permission.WRITE_EXTERNAL_STORAGE' "$MANIFEST"; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="29" />' "$MANIFEST"
          fi
          if ! grep -q 'android:usesCleartextTraffic' "$MANIFEST"; then
            sed -i '/<application/a\        android:usesCleartextTraffic="true"\n        android:networkSecurityConfig="@xml/network_security_config"' "$MANIFEST"
          fi
          NSC_FILE="android/app/src/main/res/xml/network_security_config.xml"
          mkdir -p "$(dirname "$NSC_FILE")"
          echo '<?xml version="1.0" encoding="utf-8"?><network-security-config><base-config cleartextTrafficPermitted="true"><trust-anchors><certificates src="system" /></trust-anchors></base-config></network-security-config>' > "$NSC_FILE"

      - name: Prepare Keystore (original logic)
        run: |
          keytool -genkey -v -keystore android/app/upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -alias androiddebugkey -dname "CN=Chatbox,O=Chatbox,C=CN"
          cat > android/key.properties <<EOF
          storeFile=upload-keystore.jks
          storePassword=android
          keyAlias=androiddebugkey
          keyPassword=android
          EOF

      - name: Configure build.gradle (original logic)
        run: |
          if ! grep -q "apply from: 'arm64-config.gradle'" android/app/build.gradle; then
            echo "" >> android/app/build.gradle
            echo "apply from: 'arm64-config.gradle'" >> android/app/build.gradle
            cat > android/app/arm64-config.gradle << 'EOF'
            def keystoreFile = rootProject.file('key.properties')
            def keystoreProps = new Properties()
            if (keystoreFile.exists()) { keystoreProps.load(new FileInputStream(keystoreFile)) }
            android {
                if (keystoreFile.exists()) {
                    signingConfigs { release { storeFile file(keystoreProps['storeFile']); storePassword keystoreProps['storePassword']; keyAlias keystoreProps['keyAlias']; keyPassword keystoreProps['keyPassword'] } }
                    buildTypes { release { signingConfig signingConfigs.release } }
                }
                defaultConfig { ndk { abiFilters "arm64-v8a" } }
            }
            EOF
          fi

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace
          cd ..

      # --- Package and Upload (100% restored to your successful version) ---
      - name: Package APK
        id: package_apk
        run: |
          # 1. 优先尝试最常见的固定路径 (Restore original logic)
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          
          # 2. 如果固定路径找不到，则使用 find 命令作为备用方案
          if [ ! -f "$APK_PATH" ]; then
            echo "Fixed path 'app-release.apk' not found, trying find command as fallback..."
            APK_PATH=$(find android/app/build/outputs/apk/release -type f -name "*-release.apk" ! -name "*-unsigned.apk" | head -n 1)
          fi
          
          # 3. 最终检查
          if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
            echo "::error::Signed release APK not found after all attempts!"
            echo "Listing contents of release directory for debugging:"
            ls -lR android/app/build/outputs/apk/release
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          
          VERSION=$(node -p "require('./package.json').version")
          NAME="Chatbox-Patched-Final-${VERSION}-arm64.apk"
          
          mkdir -p artifacts
          cp "$APK_PATH" "artifacts/$NAME"
          
          echo "apk_name=$NAME" >> $GITHUB_OUTPUT
          echo "✅ Packaged as $NAME"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-android-patched-apk
          path: artifacts/${{ steps.package_apk.outputs.apk_name }}
          if-no-files-found: error
